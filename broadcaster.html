<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« Ø§Ù„Ù…Ø¹Ù„Ù… - Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: #1a1a2e; color: white; padding: 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { margin: 20px 0; color: #4cc9f0; }
        video { width: 100%; max-width: 600px; background: black; border-radius: 10px; margin: 20px 0; }
        .controls { margin: 20px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        button { padding: 12px 25px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .btn-start { background: #06d6a0; color: white; }
        .btn-stop { background: #ef476f; color: white; }
        .btn-copy { background: #4361ee; color: white; }
        .status { padding: 15px; margin: 15px 0; border-radius: 10px; background: rgba(255,255,255,0.1); }
        .viewers { margin: 20px 0; }
        .viewer-item { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .link-box { background: rgba(6, 214, 160, 0.2); padding: 15px; border-radius: 10px; margin: 20px 0; word-break: break-all; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‘¨â€ğŸ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… - Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
        <p>Ø§Ù„Ø³ÙŠØ±ÙØ±: <strong>https://new-antik-p2p-20.onrender.com</strong></p>
        
        <video id="localVideo" autoplay muted playsinline></video>
        
        <div class="controls">
            <button id="startBtn" class="btn-start">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
            <button id="stopBtn" class="btn-stop" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«</button>
            <button id="copyBtn" class="btn-copy" disabled>ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        </div>
        
        <div class="status">
            <p id="roomStatus">ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·</p>
            <p id="timer">â±ï¸ 00:00:00</p>
        </div>
        
        <div class="link-box">
            <p id="shareLink">Ù‚Ù… Ø¨Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</p>
        </div>
        
        <div class="viewers">
            <h3>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† (<span id="viewerCount">0</span>)</h3>
            <div id="viewersList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ğŸ”§ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        const SERVER_URL = window.location.origin;
        let socket = null;
        let localStream = null;
        let roomId = '';
        let peerConnections = new Map();
        let broadcastStartTime = null;
        let timerInterval = null;
        
        // ğŸ”— ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        function init() {
            console.log('ğŸš€ ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…...');
            socket = io(SERVER_URL, {
                transports: ['websocket', 'polling'],
                reconnectionAttempts: 5
            });
            
            socket.on('connect', () => {
                console.log('âœ… Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±:', socket.id);
                updateStatus('ğŸŸ¢ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±', '#06d6a0');
            });
            
            socket.on('connect_error', (err) => {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„:', err);
                updateStatus('ğŸ”´ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„', '#ef476f');
            });
            
            // Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø¶Ù… Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯
            socket.on('viewer-joined', async (data) => {
                console.log('ğŸ‘¤ Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯:', data.viewerId);
                addViewer(data.viewerId);
                await createPeerConnection(data.viewerId);
            });
            
            // Ø¥Ø´Ø§Ø±Ø§Øª WebRTC Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
            socket.on('webrtc-signal', async (data) => {
                console.log('ğŸ“¡ Ø¥Ø´Ø§Ø±Ø© Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯:', data.type, data.from);
                
                if (!peerConnections.has(data.from)) {
                    await createPeerConnection(data.from);
                }
                
                const pc = peerConnections.get(data.from);
                
                try {
                    if (data.type === 'offer') {
                        await pc.setRemoteDescription(new RTCSessionDescription(data.signal));
                        const answer = await pc.createAnswer();
                        await pc.setLocalDescription(answer);
                        
                        socket.emit('webrtc-signal', {
                            to: data.from,
                            signal: answer,
                            type: 'answer'
                        });
                        
                        console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù„Ù‰:', data.from);
                        
                    } else if (data.type === 'candidate') {
                        await pc.addIceCandidate(new RTCIceCandidate(data.signal));
                        console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ICE Candidate');
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:', error);
                }
            });
            
            // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØºØ§Ø¯Ø± Ù…Ø´Ø§Ù‡Ø¯
            socket.on('viewer-left', (data) => {
                console.log('ğŸ‘‹ Ù…Ø´Ø§Ù‡Ø¯ ØºØ§Ø¯Ø±:', data.viewerId);
                removeViewer(data.viewerId);
                if (peerConnections.has(data.viewerId)) {
                    peerConnections.get(data.viewerId).close();
                    peerConnections.delete(data.viewerId);
                }
            });
        }
        
        // ğŸ¬ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
        document.getElementById('startBtn').onclick = async () => {
            try {
                const userName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ:', `Ø§Ù„Ù…Ø¹Ù„Ù…_${Date.now().toString().slice(-4)}`);
                if (!userName) return;
                
                roomId = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©:', `room_${Date.now().toString().slice(-6)}`);
                if (!roomId) return;
                
                // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                
                document.getElementById('localVideo').srcObject = localStream;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
                socket.emit('create-room', {
                    roomId: roomId,
                    userName: userName
                });
                
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('copyBtn').disabled = false;
                
                updateStatus('ğŸ”´ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± - ' + roomId, '#ef476f');
                startTimer();
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                const shareLink = `${SERVER_URL}/viewer.html?room=${roomId}`;
                document.getElementById('shareLink').textContent = shareLink;
                
                console.log('ğŸ¥ Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ØºØ±ÙØ©:', roomId);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«:', error);
                alert('Ø®Ø·Ø£: ' + error.message);
            }
        };
        
        // â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
        document.getElementById('stopBtn').onclick = () => {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«ØŸ')) {
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    document.getElementById('localVideo').srcObject = null;
                }
                
                socket.emit('end-broadcast', roomId);
                resetBroadcast();
                
                console.log('â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«');
            }
        };
        
        // ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
        document.getElementById('copyBtn').onclick = () => {
            const link = document.getElementById('shareLink').textContent;
            if (link && link !== 'Ù‚Ù… Ø¨Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©') {
                navigator.clipboard.writeText(link);
                alert('âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·');
            }
        };
        
        // ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ù…Ø¹ Ù…Ø´Ø§Ù‡Ø¯
        async function createPeerConnection(viewerId) {
            console.log('ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ù…Ø¹:', viewerId);
            
            try {
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 10
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        pc.addTrack(track, localStream);
                    });
                }
                
                // Ø¥Ø±Ø³Ø§Ù„ ICE Candidates
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('webrtc-signal', {
                            to: viewerId,
                            signal: event.candidate,
                            type: 'candidate'
                        });
                    }
                };
                
                // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
                pc.onconnectionstatechange = () => {
                    console.log(`ğŸ”Œ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¹ ${viewerId}:`, pc.connectionState);
                    if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected') {
                        pc.close();
                        peerConnections.delete(viewerId);
                        removeViewer(viewerId);
                    }
                };
                
                pc.onsignalingstatechange = () => {
                    console.log(`ğŸ“¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù…Ø¹ ${viewerId}:`, pc.signalingState);
                };
                
                peerConnections.set(viewerId, pc);
                console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ù…Ø¹:', viewerId);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC:', error);
            }
        }
        
        // â±ï¸ Ø§Ù„Ù…ÙˆÙ‚Øª
        function startTimer() {
            broadcastStartTime = new Date();
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - broadcastStartTime) / 1000);
                
                const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                
                document.getElementById('timer').textContent = `â±ï¸ ${hours}:${minutes}:${seconds}`;
            }, 1000);
        }
        
        // ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
        function addViewer(viewerId) {
            const viewersList = document.getElementById('viewersList');
            const viewerCount = document.getElementById('viewerCount');
            
            if (viewersList.textContent === 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†') {
                viewersList.innerHTML = '';
            }
            
            const viewerDiv = document.createElement('div');
            viewerDiv.className = 'viewer-item';
            viewerDiv.id = 'viewer-' + viewerId;
            viewerDiv.textContent = `ğŸ‘¤ ${viewerId.slice(0, 8)}...`;
            viewersList.appendChild(viewerDiv);
            
            viewerCount.textContent = parseInt(viewerCount.textContent) + 1;
        }
        
        function removeViewer(viewerId) {
            const viewerElement = document.getElementById('viewer-' + viewerId);
            const viewerCount = document.getElementById('viewerCount');
            
            if (viewerElement) {
                viewerElement.remove();
            }
            
            const count = parseInt(viewerCount.textContent) - 1;
            viewerCount.textContent = count > 0 ? count : 0;
            
            if (count === 0) {
                document.getElementById('viewersList').innerHTML = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†';
            }
        }
        
        // ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨Ø«
        function resetBroadcast() {
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('copyBtn').disabled = true;
            
            updateStatus('ğŸ”´ ØºÙŠØ± Ù†Ø´Ø·', '#4361ee');
            document.getElementById('shareLink').textContent = 'Ù‚Ù… Ø¨Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©';
            document.getElementById('timer').textContent = 'â±ï¸ 00:00:00';
            document.getElementById('viewerCount').textContent = '0';
            document.getElementById('viewersList').innerHTML = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†';
            
            clearInterval(timerInterval);
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            roomId = '';
        }
        
        function updateStatus(text, color) {
            const statusEl = document.getElementById('roomStatus');
            statusEl.textContent = text;
            statusEl.style.color = color;
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
