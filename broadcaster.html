<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ‘¨â€ğŸ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù… - Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .main-section {
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            flex: 1;
            margin-bottom: 20px;
            position: relative;
        }
        
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .video-overlay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4361ee;
            color: white;
        }
        
        .btn-success {
            background: #06d6a0;
            color: white;
        }
        
        .btn-danger {
            background: #ef476f;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .sidebar {
            background: rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            overflow-y: auto;
        }
        
        .room-info {
            background: rgba(67, 97, 238, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(67, 97, 238, 0.5);
        }
        
        .viewers-list {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .viewer-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .viewer-avatar {
            width: 40px;
            height: 40px;
            background: #4361ee;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }
        
        .share-link {
            background: rgba(6, 214, 160, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px dashed #06d6a0;
            word-break: break-all;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .status-offline {
            background: rgba(239, 71, 111, 0.2);
            color: #ef476f;
        }
        
        .status-live {
            background: rgba(6, 214, 160, 0.2);
            color: #06d6a0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .stats-card {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .chat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            height: 300px;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .message {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-right: 3px solid #4361ee;
        }
        
        .message-sender {
            font-weight: bold;
            color: #4cc9f0;
            margin-bottom: 5px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            outline: none;
        }
        
        .chat-input button {
            background: #4361ee;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 0 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-section">
            <div class="video-container">
                <video id="localVideo" autoplay muted playsinline></video>
                
                <div class="video-overlay">
                    <div>
                        <h3 id="broadcastTitle">Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h3>
                        <div class="status-indicator" id="statusIndicator">
                            <span class="status-offline">â— ØºÙŠØ± Ù†Ø´Ø·</span>
                        </div>
                    </div>
                    <div id="broadcastTimer">â±ï¸ 00:00:00</div>
                </div>
            </div>
            
            <div class="controls">
                <button id="startBtn" class="btn btn-success">
                    <span>â–¶ï¸</span> Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«
                </button>
                <button id="stopBtn" class="btn btn-danger" disabled>
                    <span>â¹ï¸</span> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«
                </button>
                <button id="toggleVideo" class="btn">
                    <span>ğŸ“¹</span> ÙƒØ§Ù…ÙŠØ±Ø§
                </button>
                <button id="toggleAudio" class="btn">
                    <span>ğŸ¤</span> Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                </button>
                <button id="toggleScreen" class="btn">
                    <span>ğŸ–¥ï¸</span> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
                </button>
            </div>
            
            <div class="chat-box">
                <div class="chat-messages" id="chatMessages">
                    <div class="message">
                        <div class="message-sender">Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                        <div>Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙŠÙ…ÙƒÙ†Ùƒ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ø¢Ù†</div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
                    <button onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="room-info">
                <h3>ğŸ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©</h3>
                <p id="roomIdDisplay">Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</p>
                <p id="roomStatus">Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù†Ø´Ø·</p>
            </div>
            
            <div class="stats-card">
                <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
                <div class="stat-number" id="viewerCount">0</div>
                <p>Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ù…Ø¨Ø§Ø´Ø±ÙŠÙ†</p>
            </div>
            
            <div class="viewers-list">
                <h3>ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† (<span id="viewersCount">0</span>)</h3>
                <div id="viewersContainer">
                    <div class="viewer-item">
                        <div class="viewer-avatar">ğŸ‘¤</div>
                        <div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</div>
                    </div>
                </div>
            </div>
            
            <div class="share-link">
                <h3>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</h3>
                <p id="shareLinkText">Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹</p>
                <button onclick="copyShareLink()" class="btn btn-primary" style="width:100%;margin-top:10px">
                    ğŸ“‹ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·
                </button>
            </div>
            
            <div class="stats-card">
                <h3>âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h3>
                <div style="margin: 10px 0;">
                    <label>Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«:</label>
                    <select id="qualitySelect" style="width:100%;padding:8px;margin-top:5px;background:#333;color:white;border:none;border-radius:5px">
                        <option value="720p">Ø¹Ø§Ù„ÙŠØ© (720p)</option>
                        <option value="480p">Ù…ØªÙˆØ³Ø·Ø© (480p)</option>
                        <option value="360p">Ù…Ù†Ø®ÙØ¶Ø© (360p)</option>
                    </select>
                </div>
                <div style="margin: 10px 0;">
                    <label>Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†: <span id="maxViewers">20</span></label>
                    <input type="range" id="viewerLimit" min="1" max="20" value="20" style="width:100%">
                </div>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ============ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ============
        let socket = null;
        let localStream = null;
        let screenStream = null;
        let roomId = '';
        let broadcasterName = 'Ø§Ù„Ù…Ø¹Ù„Ù…';
        let broadcastStartTime = null;
        let timerInterval = null;
        let peerConnections = new Map(); // viewerId -> RTCPeerConnection
        let viewers = new Map();
        let isBroadcasting = false;
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let isScreenSharing = false;
        
        // ============ Ø¹Ù†Ø§ØµØ± DOM ============
        const elements = {
            localVideo: document.getElementById('localVideo'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            toggleVideo: document.getElementById('toggleVideo'),
            toggleAudio: document.getElementById('toggleAudio'),
            toggleScreen: document.getElementById('toggleScreen'),
            statusIndicator: document.getElementById('statusIndicator'),
            broadcastTimer: document.getElementById('broadcastTimer'),
            roomIdDisplay: document.getElementById('roomIdDisplay'),
            roomStatus: document.getElementById('roomStatus'),
            viewerCount: document.getElementById('viewerCount'),
            viewersCount: document.getElementById('viewersCount'),
            viewersContainer: document.getElementById('viewersContainer'),
            shareLinkText: document.getElementById('shareLinkText'),
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            qualitySelect: document.getElementById('qualitySelect'),
            viewerLimit: document.getElementById('viewerLimit'),
            maxViewers: document.getElementById('maxViewers')
        };
        
        // ============ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ============
        async function init() {
            try {
                // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
                socket = io();
                
                // Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…
                broadcasterName = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ:', 'Ø§Ù„Ù…Ø¹Ù„Ù… ' + Math.floor(Math.random() * 1000)) || 'Ø§Ù„Ù…Ø¹Ù„Ù…';
                
                // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø¯Ø«Ø§Øª
                setupSocketEvents();
                setupEventListeners();
                
                console.log('âœ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¨Ø«');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚: ' + error.message);
            }
        }
        
        // ============ Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø¯Ø«Ø§Øª Socket.io ============
        function setupSocketEvents() {
            // 1. ØªØ£ÙƒÙŠØ¯ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©
            socket.on('room-created', (data) => {
                if (data.success) {
                    roomId = data.roomId;
                    
                    elements.roomIdDisplay.textContent = `Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©: ${roomId}`;
                    elements.roomStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ğŸ”´ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±';
                    elements.statusIndicator.innerHTML = '<span class="status-live">â— Ù…Ø¨Ø§Ø´Ø±</span>';
                    
                    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                    const shareLink = `${window.location.origin}/viewer.html?room=${roomId}`;
                    elements.shareLinkText.textContent = shareLink;
                    
                    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙˆÙ‚Øª
                    startBroadcastTimer();
                    
                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
                    elements.startBtn.disabled = true;
                    elements.stopBtn.disabled = false;
                    
                    isBroadcasting = true;
                    
                    // Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
                    addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', 'âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!');
                    
                    console.log('âœ… Ø§Ù„Ø¨Ø« ÙŠØ¹Ù…Ù„! Ø§Ù„Ø±Ø§Ø¨Ø·:', shareLink);
                }
            });
            
            // 2. Ù…Ø´Ø§Ù‡Ø¯ Ø¬Ø¯ÙŠØ¯ Ø§Ù†Ø¶Ù…
            socket.on('viewer-joined', (data) => {
                const { viewerId, viewerName, viewersCount } = data;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
                viewers.set(viewerId, { id: viewerId, name: viewerName });
                updateViewersList();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                elements.viewerCount.textContent = viewersCount;
                elements.viewersCount.textContent = viewersCount;
                
                // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨
                addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', `ğŸ‘‹ ${viewerName} Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø«`);
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ù…Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                createPeerConnection(viewerId, viewerName);
            });
            
            // 3. Ù…Ø´Ø§Ù‡Ø¯ ØºØ§Ø¯Ø±
            socket.on('viewer-left', (data) => {
                const { viewerId, viewerName, viewersCount } = data;
                
                // Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯
                viewers.delete(viewerId);
                updateViewersList();
                
                // Ø¥ØºÙ„Ø§Ù‚ Ø§ØªØµØ§Ù„ WebRTC
                if (peerConnections.has(viewerId)) {
                    peerConnections.get(viewerId).close();
                    peerConnections.delete(viewerId);
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                elements.viewerCount.textContent = viewersCount;
                elements.viewersCount.textContent = viewersCount;
                
                // Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
                addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', `ğŸ‘‹ ${viewerName} ØºØ§Ø¯Ø± Ø§Ù„Ø¨Ø«`);
            });
            
            // 4. Ø¥Ø´Ø§Ø±Ø§Øª WebRTC Ù…Ù† Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
            socket.on('webrtc-signal', async (data) => {
                const { from, signal, type } = data;
                
                if (!peerConnections.has(from)) {
                    await createPeerConnection(from, viewers.get(from)?.name || 'Ù…Ø´Ø§Ù‡Ø¯');
                }
                
                const pc = peerConnections.get(from);
                
                if (type === 'offer') {
                    await pc.setRemoteDescription(new RTCSessionDescription(signal));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);
                    
                    socket.emit('webrtc-signal', {
                        to: from,
                        signal: answer,
                        type: 'answer',
                        roomId: roomId
                    });
                    
                } else if (type === 'candidate') {
                    try {
                        await pc.addIceCandidate(new RTCIceCandidate(signal));
                    } catch (e) {
                        console.error('Error adding ICE candidate:', e);
                    }
                }
            });
            
            // 5. Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø´Ø§Øª
            socket.on('chat-message', (data) => {
                addChatMessage(data.userName, data.message, data.type === 'broadcaster');
            });
            
            // 6. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            socket.on('stats-update', (stats) => {
                console.log('ğŸ“Š ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', stats);
            });
            
            // 7. Ø­Ø¯Ø«Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
            socket.on('room-error', (data) => {
                alert('âš ï¸ ' + data.message);
                if (data.message.includes('Ù…Ø³ØªØ®Ø¯Ù…')) {
                    resetBroadcast();
                }
            });
        }
        
        // ============ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« ============
        elements.startBtn.onclick = async () => {
            try {
                // Ø·Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©
                roomId = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ù„Ù„ØºØ±ÙØ© (Ù…Ø«Ù„: math-class-123):', 
                    `class-${Date.now().toString().slice(-6)}`);
                
                if (!roomId || roomId.trim() === '') {
                    alert('âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ù„Ù„ØºØ±ÙØ©');
                    return;
                }
                
                // Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.localVideo.srcObject = localStream;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ© Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
                socket.emit('create-room', {
                    roomId: roomId,
                    userName: broadcasterName
                });
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«: ' + error.message);
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ³Ù…Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ Ø§Ø³ØªÙ…Ø± Ø¨Ø¯ÙˆÙ† ÙÙŠØ¯ÙŠÙˆ
                if (error.name === 'NotAllowedError') {
                    alert('âš ï¸ ÙŠÙ„Ø²Ù… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ† Ù„Ù„Ø¨Ø«');
                }
            }
        };
        
        // ============ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø« ============
        elements.stopBtn.onclick = () => {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«ØŸ Ø³ÙŠØªÙ… ÙØµÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†.')) {
                endBroadcast();
            }
        };
        
        // ============ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„Ø§Øª WebRTC ============
        async function createPeerConnection(viewerId, viewerName) {
            try {
                const pc = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø­Ù„ÙŠ
                if (localStream) {
                    localStream.getTracks().forEach(track => {
                        pc.addTrack(track, localStream);
                    });
                }
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØ¯ÙÙ‚ Ø´Ø§Ø´Ø©ØŒ Ø£Ø¶ÙÙ‡ Ø£ÙŠØ¶Ø§Ù‹
                if (screenStream) {
                    screenStream.getTracks().forEach(track => {
                        pc.addTrack(track, screenStream);
                    });
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø±Ø¶ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
                socket.emit('webrtc-signal', {
                    to: viewerId,
                    signal: offer,
                    type: 'offer',
                    roomId: roomId
                });
                
                // Ø­Ø¯Ø« ICE Candidate
                pc.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('webrtc-signal', {
                            to: viewerId,
                            signal: event.candidate,
                            type: 'candidate',
                            roomId: roomId
                        });
                    }
                };
                
                // Ø­Ø¯Ø« Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„
                pc.onconnectionstatechange = () => {
                    if (pc.connectionState === 'disconnected' || pc.connectionState === 'failed') {
                        console.log(`âŒ Ø§Ù†Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ ${viewerName}`);
                        pc.close();
                        peerConnections.delete(viewerId);
                    }
                };
                
                // Ø­ÙØ¸ Ø§Ù„Ø§ØªØµØ§Ù„
                peerConnections.set(viewerId, pc);
                
                console.log(`âœ… Ø§ØªØµØ§Ù„ WebRTC Ù…Ø¹ ${viewerName} (${viewerId})`);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC:', error);
            }
        }
        
        // ============ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ============
        function updateViewersList() {
            elements.viewersContainer.innerHTML = '';
            
            if (viewers.size === 0) {
                elements.viewersContainer.innerHTML = `
                    <div class="viewer-item">
                        <div class="viewer-avatar">ğŸ‘¤</div>
                        <div>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†</div>
                    </div>
                `;
                return;
            }
            
            viewers.forEach(viewer => {
                const viewerElement = document.createElement('div');
                viewerElement.className = 'viewer-item';
                viewerElement.innerHTML = `
                    <div class="viewer-avatar">${viewer.name.charAt(0)}</div>
                    <div>
                        <strong>${viewer.name}</strong>
                        <small style="display:block;color:#aaa">${viewer.id.slice(0, 8)}...</small>
                    </div>
                `;
                elements.viewersContainer.appendChild(viewerElement);
            });
        }
        
        // ============ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø« ============
        function startBroadcastTimer() {
            broadcastStartTime = new Date();
            clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - broadcastStartTime) / 1000);
                
                const hours = Math.floor(diff / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
                const seconds = (diff % 60).toString().padStart(2, '0');
                
                elements.broadcastTimer.textContent = `â±ï¸ ${hours}:${minutes}:${seconds}`;
            }, 1000);
        }
        
        function endBroadcast() {
            // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¯ÙÙ‚Ø§Øª
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
            }
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§ØªØµØ§Ù„Ø§Øª WebRTC
            peerConnections.forEach(pc => pc.close());
            peerConnections.clear();
            
            // Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ø³ÙŠØ±ÙØ±
            if (roomId && socket) {
                socket.emit('end-broadcast', roomId);
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
            resetBroadcast();
            
            // Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø´Ø§Øª
            addChatMessage('Ø§Ù„Ù†Ø¸Ø§Ù…', 'â¹ï¸ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨Ø«');
        }
        
        function resetBroadcast() {
            elements.localVideo.srcObject = null;
            elements.roomIdDisplay.textContent = 'Ù„Ù… ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©';
            elements.roomStatus.textContent = 'Ø§Ù„Ø­Ø§Ù„Ø©: ØºÙŠØ± Ù†Ø´Ø·';
            elements.statusIndicator.innerHTML = '<span class="status-offline">â— ØºÙŠØ± Ù†Ø´Ø·</span>';
            elements.broadcastTimer.textContent = 'â±ï¸ 00:00:00';
            elements.shareLinkText.textContent = 'Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹';
            elements.viewerCount.textContent = '0';
            elements.viewersCount.textContent = '0';
            
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            
            clearInterval(timerInterval);
            
            viewers.clear();
            updateViewersList();
            
            isBroadcasting = false;
            roomId = '';
        }
        
        // ============ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ============
        function addChatMessage(sender, message, isBroadcaster = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            const senderClass = isBroadcaster ? 'message-sender broadcaster' : 'message-sender';
            
            messageDiv.innerHTML = `
                <div class="${senderClass}">${sender} ${isBroadcaster ? 'ğŸ‘¨â€ğŸ«' : ''}</div>
                <div>${message}</div>
            `;
            
            elements.chatMessages.appendChild(messageDiv);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }
        
        function sendMessage() {
            const message = elements.chatInput.value.trim();
            if (message && socket && roomId) {
                socket.emit('chat-message', { message });
                addChatMessage(broadcasterName, message, true);
                elements.chatInput.value = '';
            }
        }
        
        // ============ Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ============
        function copyShareLink() {
            const link = elements.shareLinkText.textContent;
            if (link && link !== 'Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø£ÙˆÙ„Ø§Ù‹') {
                navigator.clipboard.writeText(link)
                    .then(() => alert('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«'))
                    .catch(() => {
                        // Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¥Ø°Ø§ ÙØ´Ù„Øª Clipboard API
                        const textarea = document.createElement('textarea');
                        textarea.value = link;
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        alert('âœ… ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«');
                    });
            }
        }
        
        // ============ Ø¥Ø¹Ø¯Ø§Ø¯ Ø­Ø¯Ø«Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… ============
        function setupEventListeners() {
            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            elements.toggleVideo.onclick = () => {
                if (localStream) {
                    const videoTrack = localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        isVideoEnabled = !videoTrack.enabled;
                        videoTrack.enabled = isVideoEnabled;
                        elements.toggleVideo.innerHTML = isVideoEnabled ? '<span>ğŸ“¹</span> ÙƒØ§Ù…ÙŠØ±Ø§' : '<span>ğŸ“µ</span> ÙƒØ§Ù…ÙŠØ±Ø§';
                    }
                }
            };
            
            // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙˆØª
            elements.toggleAudio.onclick = () => {
                if (localStream) {
                    const audioTrack = localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        isAudioEnabled = !audioTrack.enabled;
                        audioTrack.enabled = isAudioEnabled;
                        elements.toggleAudio.innerHTML = isAudioEnabled ? '<span>ğŸ¤</span> Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†' : '<span>ğŸ”‡</span> Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†';
                    }
                }
            };
            
            // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
            elements.toggleScreen.onclick = async () => {
                try {
                    if (!isScreenSharing) {
                        screenStream = await navigator.mediaDevices.getDisplayMedia({
                            video: true,
                            audio: true
                        });
                        
                        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ØªØ¯ÙÙ‚ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§ØªØµØ§Ù„Ø§Øª WebRTC
                        peerConnections.forEach(pc => {
                            const senders = pc.getSenders();
                            const videoSender = senders.find(s => s.track && s.track.kind === 'video');
                            if (videoSender && screenStream.getVideoTracks()[0]) {
                                videoSender.replaceTrack(screenStream.getVideoTracks()[0]);
                            }
                        });
                        
                        isScreenSharing = true;
                        elements.toggleScreen.innerHTML = '<span>ğŸ–¥ï¸</span> Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø´Ø§Ø´Ø©';
                        
                        // Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©
                        screenStream.getVideoTracks()[0].onended = () => {
                            stopScreenSharing();
                        };
                        
                    } else {
                        stopScreenSharing();
                    }
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©:', error);
                }
            };
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¬ÙˆØ¯Ø©
            elements.qualitySelect.onchange = () => {
                // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªØºÙŠÙŠØ± Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø« Ù‡Ù†Ø§
                console.log('Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¨Ø«:', elements.qualitySelect.value);
            };
            
            // Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†
            elements.viewerLimit.oninput = () => {
                const limit = elements.viewerLimit.value;
                elements.maxViewers.textContent = limit;
                console.log('Ø­Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†:', limit);
            };
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„Ø¥Ù†ØªØ±
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        function stopScreenSharing() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¯ÙÙ‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            if (localStream) {
                peerConnections.forEach(pc => {
                    const senders = pc.getSenders();
                    const videoSender = senders.find(s => s.track && s.track.kind === 'video');
                    if (videoSender && localStream.getVideoTracks()[0]) {
                        videoSender.replaceTrack(localStream.getVideoTracks()[0]);
                    }
                });
            }
            
            isScreenSharing = false;
            elements.toggleScreen.innerHTML = '<span>ğŸ–¥ï¸</span> Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø§Ø´Ø©';
        }
        
        // ============ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ============
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
