<!DOCTYPE html>
<html>
<head>
    <title>Broadcaster</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h1>Broadcaster Page</h1>
    <video id="localVideo" autoplay muted playsinline style="width:400px; border: 1px solid black;"></video>
    <br>
    <button id="startBtn">Start Broadcasting</button>
    <p>Status: <span id="status">Waiting</span></p>
    <p id="link-container" style="display:none;">Share this link: <a id="share-link" href="#" target="_blank"></a></p>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>
    <script>
        const socket = io("https://new-antik-p2p-20.onrender.com");
        const mediasoupClient = window.mediasoupClient;
        const device = new mediasoupClient.Device();
        let producerTransport;

        const startBtn = document.getElementById('startBtn');
        const localVideo = document.getElementById('localVideo');
        const statusEl = document.getElementById('status');
        const linkContainer = document.getElementById('link-container');
        const shareLink = document.getElementById('share-link');

        startBtn.onclick = async () => {
            startBtn.disabled = true;
            statusEl.innerText = 'Connecting...';

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = stream;

                const routerRtpCapabilities = await new Promise(r => socket.emit('getRouterRtpCapabilities', r));
                await device.load({ routerRtpCapabilities });

                const transportParams = await new Promise(r => socket.emit('createProducerTransport', r));
                producerTransport = device.createSendTransport(transportParams);

                producerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    socket.emit('connectProducerTransport', { dtlsParameters }, () => callback());
                });

                producerTransport.on('produce', async (parameters, callback, errback) => {
                    try {
                        const { id } = await new Promise(r => socket.emit('produce', { kind: parameters.kind, rtpParameters: parameters.rtpParameters }, r));
                        callback({ id });
                    } catch (err) {
                        errback(err);
                    }
                });

                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) await producerTransport.produce({ track: videoTrack });
                
                const audioTrack = stream.getAudioTracks()[0];
                if (audioTrack) await producerTransport.produce({ track: audioTrack });

                statusEl.innerText = 'Broadcasting!';
                const broadcastId = Math.random().toString(36).substring(2, 8);
                const link = `https://pokiklas123-wq.github.io/new-antik/player.html?id=${broadcastId}`;
                shareLink.href = link;
                shareLink.innerText = link;
                linkContainer.style.display = 'block';

            } catch (err) {
                console.error(err);
                statusEl.innerText = 'Failed!';
                startBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
