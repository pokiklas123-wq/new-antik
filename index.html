<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø¯ÙŠØ¹ - Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f0f0; }
        video { width: 100%; max-width: 600px; background: #000; border-radius: 8px; margin: 10px 0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; margin: 5px; }
        button:disabled { background: #ccc; }
        .status { margin-top: 10px; font-weight: bold; }
        #link-area { display: none; margin-top: 15px; padding: 10px; background: #fff; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>ğŸ¥ Ø§Ù„Ù…Ø¯ÙŠØ¹ - Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±</h1>
    
    <video id="localVideo" autoplay muted playsinline></video>
    
    <div>
        <button id="startBtn">â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
    </div>

    <p class="status">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="status">ØºÙŠØ± Ù…ØªØµÙ„</span></p>

    <div id="link-area">
        <p>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†:</p>
        <a id="share-link" href="#" target="_blank">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</a>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø§Øª Socket.io Ùˆ Mediasoup -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>

    <script>
        // Ù‡Ø§Ù…: Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£Ø¯Ù†Ø§Ù‡ Ø¨Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø¯Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¹Ù„Ù‰ Render
        const socket = io("https://new-antik-p2p-20.onrender.com");
        
        const mediasoupClient = window.mediasoupClient;
        const device = new mediasoupClient.Device();
        let producerTransport;
        let videoProducer;
        let audioProducer;

        const startBtn = document.getElementById('startBtn');
        const localVideo = document.getElementById('localVideo');
        const statusEl = document.getElementById('status');
        const linkArea = document.getElementById('link-area');
        const shareLink = document.getElementById('share-link');

        startBtn.onclick = async () => {
            startBtn.disabled = true;
            statusEl.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';

            try {
                // 1. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙŠØ¯ÙŠØ§ (ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙ…ÙŠÙƒØ±ÙˆÙÙˆÙ†)
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = stream;

                // 2. ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§ÙˆØªØ±
                const routerRtpCapabilities = await new Promise(resolve => {
                    socket.emit('getRouterRtpCapabilities', (data) => resolve(data));
                });
                await device.load({ routerRtpCapabilities });

                // 3. Ø¥Ù†Ø´Ø§Ø¡ Transport Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
                const transportParams = await new Promise((resolve, reject) => {
                    socket.emit('createProducerTransport', (data) => {
                        if (data.error) reject(data.error);
                        else resolve(data);
                    });
                });

                producerTransport = device.createSendTransport(transportParams);

                // 4. Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Transport
                producerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    socket.emit('connectProducerTransport', { dtlsParameters }, () => callback());
                });

                producerTransport.on('produce', async (parameters, callback, errback) => {
                    try {
                        const { id } = await new Promise(resolve => {
                            socket.emit('produce', { 
                                kind: parameters.kind, 
                                rtpParameters: parameters.rtpParameters 
                            }, resolve);
                        });
                        callback({ id });
                    } catch (err) {
                        errback(err);
                    }
                });

                // 5. Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« (Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„ØµÙˆØª)
                const videoTrack = stream.getVideoTracks()[0];
                const audioTrack = stream.getAudioTracks()[0];

                if (videoTrack) {
                    videoProducer = await producerTransport.produce({ track: videoTrack });
                }
                if (audioTrack) {
                    audioProducer = await producerTransport.produce({ track: audioTrack });
                }

                statusEl.innerText = 'ğŸ”´ Ø§Ù„Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†';
                statusEl.style.color = 'red';

                // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© (ÙŠÙØªØ±Ø¶ Ø£Ù† Ù…Ù„Ù Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ø§Ø³Ù…Ù‡ player.html)
                linkArea.style.display = 'block';
                const viewerUrl = `https://pokiklas123-wq.github.io/new-antik/player.html`; 
                shareLink.href = viewerUrl;
                shareLink.innerText = viewerUrl;

            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø«:", err);
                statusEl.innerText = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message;
                startBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
