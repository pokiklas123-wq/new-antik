<!DOCTYPE html>
<html>
<head>
    <title>Ø§Ù„Ù…Ø¹Ù„Ù… - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h2>Ø¨Ø¯Ø¡ Ø¨Ø« Ø¬Ø¯ÙŠØ¯</h2>
    <video id="localVideo" autoplay muted playsinline style="width:400px; border:1px solid #ccc;"></video><br>
    <button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
    <p>Ø§Ù„Ø­Ø§Ù„Ø©: <span id="status">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ´ØºÙŠÙ„...</span></p>
    <p id="link-container" style="display:none; background:#e9f7ef; padding:10px; border-radius:5px; word-break:break-all;">
        <strong>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†:</strong><br>
        <a id="share-link" href="#" target="_blank"></a>
    </p>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>
    <script>
        const socket = io("https://new-antik-p2p-20.onrender.com");
        const mediasoupClient = window.mediasoupClient;
        const device = new mediasoupClient.Device();
        let producerTransport, videoProducer, audioProducer, broadcastId = "";
        const startBtn = document.getElementById('startBtn'), localVideo = document.getElementById('localVideo'),
              statusEl = document.getElementById('status'), linkContainer = document.getElementById('link-container'),
              shareLink = document.getElementById('share-link');

        startBtn.onclick = async () => {
            startBtn.disabled = true; statusEl.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = stream; broadcastId = Math.random().toString(36).substring(2, 10);
                const transportParams = await new Promise(r => socket.emit('createProducerTransport', { roomId: broadcastId }, r));
                if (transportParams.error) throw new Error(transportParams.error);
                const routerRtpCapabilities = await new Promise(r => socket.emit('getRouterRtpCapabilities', { roomId: broadcastId }, r));
                await device.load({ routerRtpCapabilities });
                producerTransport = device.createSendTransport(transportParams);
                producerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    socket.emit('connectProducerTransport', { transportId: producerTransport.id, dtlsParameters }, (res) => {
                        res.success ? callback() : errback(new Error(res.error));
                    });
                });
                producerTransport.on('produce', async (parameters, callback, errback) => {
                    const { id } = await new Promise(r => socket.emit('produce', { transportId: producerTransport.id, kind: parameters.kind, rtpParameters: parameters.rtpParameters }, r));
                    callback({ id });
                });
                const videoTrack = stream.getVideoTracks()[0]; if (videoTrack) videoProducer = await producerTransport.produce({ track: videoTrack });
                const audioTrack = stream.getAudioTracks()[0]; if (audioTrack) audioProducer = await producerTransport.produce({ track: audioTrack });
                statusEl.innerText = 'ğŸ”´ Ø§Ù„Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†!'; statusEl.style.color = 'green';
                const link = `https://pokiklas123-wq.github.io/new-antik/player.html?id=${broadcastId}`;
                shareLink.href = link; shareLink.innerText = link; linkContainer.style.display = 'block';
            } catch (err) {
                console.error(err); statusEl.innerText = 'âŒ ÙØ´Ù„ Ø§Ù„Ø¨Ø«!'; statusEl.style.color = 'red';
                startBtn.disabled = false; alert(`Ø®Ø·Ø£: ${err.message}`);
            }
        };
    </script>
</body>
</html>
