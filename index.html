<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ù…Ø°ÙŠØ¹ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; background: #f4f4f9; color: #333; }
        h1 { color: #444; }
        video { width: 100%; max-width: 600px; background: #000; border-radius: 12px; margin: 20px 0; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        button { padding: 12px 25px; font-size: 18px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 8px; transition: 0.3s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 15px; font-weight: bold; font-size: 1.1em; }
        #link-area { display: none; margin-top: 20px; padding: 15px; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
        #share-link { color: #007bff; text-decoration: none; word-break: break-all; }
    </style>
</head>
<body>
    <h1>ğŸ¥ Ø§Ù„Ù…Ø°ÙŠØ¹ - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</h1>
    
    <video id="localVideo" autoplay muted playsinline></video>
    
    <div>
        <button id="startBtn">â–¶ Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«</button>
    </div>

    <p class="status">Ø§Ù„Ø­Ø§Ù„Ø©: <span id="status">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„</span></p>

    <div id="link-area">
        <p>âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø«! Ø£Ø±Ø³Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ†:</p>
        <a id="share-link" href="#" target="_blank">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²...</a>
    </div>

    <!-- Ù…ÙƒØªØ¨Ø§Øª Socket.io Ùˆ Mediasoup -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>

    <script>
        // âš ï¸ Ù‡Ø§Ù…: ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ·Ø§Ø¨Ù‚ Ø±Ø§Ø¨Ø· Ø³ÙŠØ±ÙØ±Ùƒ Ø¹Ù„Ù‰ Render
        const socket = io("https://new-antik-p2p-20.onrender.com");
        
        const mediasoupClient = window.mediasoupClient;
        const device = new mediasoupClient.Device();
        let producerTransport;
        let videoProducer;
        let audioProducer;

        const startBtn = document.getElementById('startBtn');
        const localVideo = document.getElementById('localVideo');
        const statusEl = document.getElementById('status');
        const linkArea = document.getElementById('link-area');
        const shareLink = document.getElementById('share-link');

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then((stream) => {
                localVideo.srcObject = stream;
            })
            .catch((err) => {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", err);
                statusEl.innerText = "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†";
            });

        startBtn.onclick = async () => {
            startBtn.disabled = true;
            statusEl.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...';

            try {
                const stream = localVideo.srcObject;
                if (!stream) throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§");

                // 1. ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§ÙˆØªØ±
                const routerRtpCapabilities = await new Promise(resolve => {
                    socket.emit('getRouterRtpCapabilities', (data) => resolve(data));
                });
                await device.load({ routerRtpCapabilities });

                // 2. Ø¥Ù†Ø´Ø§Ø¡ Transport Ù„Ù„Ø¥Ø±Ø³Ø§Ù„
                const transportParams = await new Promise((resolve, reject) => {
                    socket.emit('createProducerTransport', (data) => {
                        if (data.error) reject(data.error);
                        else resolve(data);
                    });
                });

                producerTransport = device.createSendTransport(transportParams);

                producerTransport.on('connect', async ({ dtlsParameters }, callback, errback) => {
                    socket.emit('connectProducerTransport', { dtlsParameters }, () => callback());
                });

                producerTransport.on('produce', async (parameters, callback, errback) => {
                    try {
                        const { id } = await new Promise(resolve => {
                            socket.emit('produce', { 
                                kind: parameters.kind, 
                                rtpParameters: parameters.rtpParameters 
                            }, resolve);
                        });
                        callback({ id });
                    } catch (err) {
                        errback(err);
                    }
                });

                // 3. Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„ÙØ¹Ù„ÙŠ
                const videoTrack = stream.getVideoTracks()[0];
                const audioTrack = stream.getAudioTracks()[0];

                if (videoTrack) videoProducer = await producerTransport.produce({ track: videoTrack });
                if (audioTrack) audioProducer = await producerTransport.produce({ track: audioTrack });

                statusEl.innerText = 'ğŸ”´ Ø§Ù„Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†';
                statusEl.style.color = 'red';

                // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø§Ø¨Ø·
                linkArea.style.display = 'block';
                // Ù†ÙØªØ±Ø¶ Ø£Ù† Ù…Ù„Ù Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ Ø§Ø³Ù…Ù‡ player.html ÙˆÙ…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯
                const currentUrl = window.location.href;
                const viewerUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/')) + '/player.html';
                shareLink.href = viewerUrl;
                shareLink.innerText = viewerUrl;

            } catch (err) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø«:", err);
                statusEl.innerText = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + err.message;
                startBtn.disabled = false;
            }
        };
    </script>
</body>
</html>
