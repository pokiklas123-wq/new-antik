<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ¬ Ù…Ø´ØºÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        
        #videoContainer {
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="remoteVideo" autoplay playsinline muted></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let peerConnection;
        let currentRoomId = null;
        let currentUserName = null;
        
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        };

        // Ø¯Ø§Ù„Ø© Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù…Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        function extractParamsFromURL() {
            const url = new URL(window.location.href);
            const roomParam = url.searchParams.get('room');
            
            if (!roomParam) {
                redirectToError('no-room');
                return { roomId: null, userName: null };
            }
            
            const parts = roomParam.split('/');
            
            if (parts.length < 2 || !parts[0] || !parts[1]) {
                redirectToError('invalid-format');
                return { roomId: null, userName: null };
            }
            
            const roomId = parts[0];
            const userName = decodeURIComponent(parts[1]);
            
            if (!roomId || !userName) {
                redirectToError('invalid-data');
                return { roomId: null, userName: null };
            }
            
            return { roomId, userName };
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø®Ø·Ø£
        function redirectToError(errorType) {
            const url = new URL(window.location.href);
            const roomParam = url.searchParams.get('room');
            
            let errorUrl = 'https://new-antik-p2p-20.onrender.com/error.html';
            
            if (roomParam) {
                errorUrl += `?room=${roomParam}`;
            }
            
            errorUrl += `&error=${errorType}`;
            window.location.href = errorUrl;
        }

        // Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        function autoJoin() {
            const { roomId, userName } = extractParamsFromURL();
            
            if (roomId && userName) {
                currentRoomId = roomId;
                currentUserName = userName;
                
                socket.emit('join-room', { roomId, userName });
            }
        }

        // --- Ø§Ø³ØªÙ…Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³ÙŠØ±ÙØ± ---
        socket.on('joined-room', () => {
            // Ù„Ø§ Ø´ÙŠØ¡ - Ù…Ø¬Ø±Ø¯ Ø§ØªØµØ§Ù„
        });

        // Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ø¹Ø±Ø¶ (offer) Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…
        socket.on('webrtc-offer', async (data) => {
            try {
                if (!peerConnection) {
                    createPeerConnection(data.from);
                }
                
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('webrtc-answer', { 
                    to: data.from, 
                    roomId: currentRoomId,
                    answer: answer 
                });
                
            } catch (error) {
                redirectToError('connection-failed');
            }
        });

        // Ø§Ø³ØªÙ…Ø¹ Ù„Ù„Ù…Ø±Ø´Ø­ÙŠÙ† (ICE Candidates)
        socket.on('webrtc-candidate', async (data) => {
            if (peerConnection && data.candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (error) {
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£
                }
            }
        });

        function createPeerConnection(broadcasterId) {
            peerConnection = new RTCPeerConnection(rtcConfig);
            
            peerConnection.ontrack = (event) => {
                const videoEl = document.getElementById('remoteVideo');
                videoEl.srcObject = event.streams[0];
                
                videoEl.play().catch(() => {
                    // ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
                });
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('webrtc-candidate', { 
                        to: broadcasterId, 
                        roomId: currentRoomId,
                        candidate: event.candidate 
                    });
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'disconnected' || 
                    peerConnection.connectionState === 'failed') {
                    redirectToError('stream-ended');
                }
            };
        }

        // Ø­Ø¯Ø« Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…
        socket.on('broadcast-ended', () => {
            redirectToError('stream-ended');
        });
        
        // Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        socket.on('error', (data) => {
            if (data.message && (data.message.includes('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯') || data.message.includes('not found'))) {
                redirectToError('room-not-found');
            } else {
                redirectToError('server-error');
            }
        });

        // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
        socket.on("connect_error", () => {
            redirectToError('server-unreachable');
        });

        // Ø§Ø³ØªÙ…Ø¹ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø¬Ø§Ø¨Ø© (answer) Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        socket.on('webrtc-answer', async (data) => {
            if (peerConnection && data.answer) {
                try {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                } catch (error) {
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£
                }
            }
        });

        // Ø­Ø§ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = autoJoin;
        
        // Ø£Ø¶Ù Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¯ÙˆÙŠØ§Ù‹
        document.addEventListener('click', function() {
            const videoEl = document.getElementById('remoteVideo');
            if (videoEl.srcObject) {
                videoEl.play().catch(() => {
                    // ØªØ¬Ø§Ù‡Ù„ Ø®Ø·Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„
                });
            }
        });
    </script>
</body>
</html>
