<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¬ Ù…Ø´ØºÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: 'Segoe UI', sans-serif;
        }
        
        #videoContainer {
            width: 100vw;
            height: 100vh;
            background: #000;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transform: scaleX(-1); /* Ù‚Ù„Ø¨ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        }
        
        /* Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ…Ø§Øª */
        #controlsOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
            pointer-events: none;
        }
        
        #controlsOverlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Ø²Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª ÙÙ‚Ø· */
        .control-btn {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            backdrop-filter: blur(5px);
            width: 70px;
            height: 70px;
            font-size: 30px;
        }
        
        .control-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.2);
        }

        /* Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 5;
        }

    </style>
</head>
<body>
    <div id="videoContainer">
        <div id="loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¨Ø«...</div>
        <video id="remoteVideo" autoplay playsinline></video>
        
        <!-- Ø·Ø¨Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ…Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ³Ø· -->
        <div id="controlsOverlay">
            <!-- Ø²Ø± ÙƒØªÙ… Ø§Ù„ØµÙˆØª ÙÙ‚Ø· -->
            <button id="muteBtn" class="control-btn">
                <i class="fas fa-volume-up"></i>
            </button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let peerConnection;
        let currentRoomId = null;
        let currentUserName = null;
        let controlsTimeout;
        let isVideoPlaying = false;
        
        const rtcConfig = {
    iceServers: [
        // Ø®Ø§Ø¯Ù… STUN
        { urls: 'stun:stun.l.google.com:19302' },
        // Ø®Ø§Ø¯Ù… TURN Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (UDP)
        {
            urls: 'turn:relay1.expressturn.com:3480',
            username: '000000002082111515',
            credential: 'HC4BPBxsHVvEIw+TIvW/a44WRFA='
        },
        // Ø®Ø§Ø¯Ù… TURN Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… TCP (ÙƒØ¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ØªÙ… Ø­Ø¸Ø± UDP)
        {
            urls: 'turn:relay1.expressturn.com:3480?transport=tcp',
            username: '000000002082111515',
            credential: 'HC4BPBxsHVvEIw+TIvW/a44WRFA='
        }
    ],
    sdpSemantics: 'unified-plan' // âœ… Ù…Ù‡Ù… Ù„ÙÙŠØ¯ÙŠÙˆ WebRTC
};

        // === Ø¹Ù†Ø§ØµØ± DOM ===
        const videoContainer = document.getElementById('videoContainer');
        const video = document.getElementById('remoteVideo');
        const controlsOverlay = document.getElementById('controlsOverlay');
        const muteBtn = document.getElementById('muteBtn');
        const loading = document.getElementById('loading');

        // === ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ===
        
        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­ÙƒÙ…Ø§Øª
        function toggleControls(e) {
            if (e.target.closest('.control-btn')) return;

            if (controlsOverlay.classList.contains('show')) {
                hideControls();
            } else {
                showControls();
            }
        }

        function showControls() {
            controlsOverlay.classList.add('show');
            resetHideTimer();
        }

        function hideControls() {
            controlsOverlay.classList.remove('show');
            clearTimeout(controlsTimeout);
        }

        function resetHideTimer() {
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(hideControls, 3000);
        }
        
        // ÙƒØªÙ… Ø§Ù„ØµÙˆØª
        function toggleMute() {
            video.muted = !video.muted;
            updateMuteIcon();
            resetHideTimer();
        }

        function updateMuteIcon() {
            if (video.muted) {
                muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                muteBtn.style.color = '#ff4444';
            } else {
                muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                muteBtn.style.color = 'white';
            }
        }

        // === Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ===
        
        videoContainer.addEventListener('click', toggleControls);
        videoContainer.addEventListener('touchstart', () => {
             if (!controlsOverlay.classList.contains('show')) showControls();
        }, {passive: true});

        muteBtn.addEventListener('click', toggleMute);

        // âœ… Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„ÙÙŠØ¯ÙŠÙˆ
        video.addEventListener('loadeddata', () => {
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
            if (loading) loading.style.display = 'none';
            isVideoPlaying = true;
        });

        video.addEventListener('canplay', () => {
            console.log('ğŸ¬ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
            video.play().catch(e => console.log('ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', e));
        });

        video.addEventListener('error', (e) => {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', e);
            if (loading) loading.innerHTML = 'âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ';
        });

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
        function createPeerConnection(broadcasterId) {
            console.log('ğŸ”— Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ø¬Ø¯ÙŠØ¯');
            
            peerConnection = new RTCPeerConnection(rtcConfig);
            
            // âœ… ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© ØªÙŠØ§Ø± Ø§Ù„ÙˆØ³Ø§Ø¦Ø·
            peerConnection.ontrack = (event) => {
                console.log('ğŸ“¹ ØªÙ… Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªÙŠØ§Ø± ÙˆØ³Ø§Ø¦Ø·:', event.track.kind);
                
                if (event.track.kind === 'video') {
                    console.log('ğŸ¥ ØªÙŠØ§Ø± ÙÙŠØ¯ÙŠÙˆ Ù…Ø³ØªÙ„Ù…');
                }
                
                // âœ… ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹ÙŠÙŠÙ† srcObject Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
                if (!video.srcObject && event.streams && event.streams[0]) {
                    video.srcObject = event.streams[0];
                    console.log('âœ… ØªÙ… ØªØ¹ÙŠÙŠÙ† srcObject Ù„Ù„ÙÙŠØ¯ÙŠÙˆ');
                    
                    // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
                    setTimeout(() => {
                        video.play()
                            .then(() => {
                                console.log('â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù†Ø§Ø¬Ø­');
                                if (loading) loading.style.display = 'none';
                                isVideoPlaying = true;
                                showControls();
                            })
                            .catch(err => {
                                console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:', err.message);
                                // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                                video.play().catch(e => console.log('Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©:', e));
                            });
                    }, 500);
                }
            };
            
            // âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„ØªÙŠØ§Ø±Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
            peerConnection.addEventListener('track', (event) => {
                console.log('ğŸ¯ Track event:', event.track.kind);
            });
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', { 
                        roomId: currentRoomId, 
                        candidate: event.candidate 
                    });
                }
            };
            
            peerConnection.onconnectionstatechange = () => {
                console.log('ğŸ”„ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', peerConnection.connectionState);
                if (peerConnection.connectionState === 'disconnected' || 
                    peerConnection.connectionState === 'failed') {
                    console.log('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„');
                    setTimeout(() => redirectToError('stream-ended'), 2000);
                }
                if (peerConnection.connectionState === 'connected') {
                    console.log('âœ… Ø§ØªØµØ§Ù„ WebRTC Ù†Ø§Ø¬Ø­');
                    if (loading) loading.innerHTML = 'âœ… Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...';
                }
            };
            
            peerConnection.onsignalingstatechange = () => {
                console.log('ğŸ“¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:', peerConnection.signalingState);
            };
            
            peerConnection.oniceconnectionstatechange = () => {
                console.log('â„ï¸ Ø­Ø§Ù„Ø© ICE:', peerConnection.iceConnectionState);
            };
        }

        // âœ… Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶
        async function handleOffer(data) {
            if (!peerConnection) createPeerConnection(data.from);
            
            try {
                console.log('ğŸ“¨ Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ø±Ø¶ WebRTC');
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                
                // âœ… Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ù…ØªØ·Ù„Ø¨Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                const answer = await peerConnection.createAnswer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('answer', { 
                    to: data.from, 
                    roomId: currentRoomId, 
                    sdp: answer 
                });
                
                console.log('ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶:', error);
                redirectToError('connection-failed');
            }
        }

        // === WebRTC Code Ø§Ù„Ù…Ø¹Ø¯Ù„ ===
        function getParamsFromURL() {
            try {
                const url = new URL(window.location.href);
                const roomParam = url.searchParams.get('room');
                if (!roomParam) throw new Error('no-room');
                const parts = roomParam.split('/');
                if (parts.length < 2 || !parts[0] || !parts[1]) throw new Error('invalid-format');
                return { roomId: parts[0], userName: decodeURIComponent(parts[1]) };
            } catch (error) {
                redirectToError(error.message);
                return null;
            }
        }
        
        function redirectToError(errorType) {
            const url = new URL(window.location.href);
            const roomParam = url.searchParams.get('room') || '';
            window.location.href = `https://new-antik-p2p-20.onrender.com/error.html?room=${roomParam}&error=${errorType}`;
        }
        
        function connectToStream() {
            const params = getParamsFromURL();
            if (!params) return;
            currentRoomId = params.roomId;
            currentUserName = params.userName;
            
            console.log(`ğŸš€ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©: ${currentRoomId}, Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUserName}`);
            
            socket.emit('join-room', { roomId: currentRoomId, userName: currentUserName });
            showControls();
        }
        
        socket.on('joined-room', () => {
            console.log('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©');
            if (loading) loading.innerHTML = 'ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¹Ù„Ù…...';
        });
        
        // âœ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø©
        socket.on('offer', handleOffer);
        
        socket.on('webrtc-signal', async (data) => {
            console.log(`ğŸ“¡ Ø¥Ø´Ø§Ø±Ø© WebRTC: ${data.type} Ù…Ù† ${data.from}`);
            
            if (!peerConnection && data.type === 'offer') createPeerConnection(data.from);
            
            try {
                if (data.type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
                    const answer = await peerConnection.createAnswer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    await peerConnection.setLocalDescription(answer);
                    socket.emit('webrtc-signal', { 
                        to: data.from, 
                        type: 'answer', 
                        signal: answer 
                    });
                } else if (data.type === 'candidate' && peerConnection) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.signal));
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø´Ø§Ø±Ø© WebRTC:', error);
                redirectToError('connection-failed');
            }
        });
        
        socket.on('ice-candidate', async (data) => {
            if (peerConnection && data.candidate) {
                try { 
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                    console.log('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ICE candidate');
                } catch (e) {
                    console.log('âš ï¸ Ø®Ø·Ø£ ÙÙŠ ICE candidate:', e);
                }
            }
        });
        
        socket.on('broadcast-ended', () => {
            console.log('â¹ï¸ Ø§Ù„Ø¨Ø« Ø§Ù†ØªÙ‡Ù‰');
            redirectToError('stream-ended');
        });
        
        socket.on('room-not-found', () => redirectToError('room-not-found'));
        socket.on('error', () => redirectToError('server-error'));
        socket.on("connect_error", () => redirectToError('server-unreachable'));
        
        // âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ
        const checkVideoInterval = setInterval(() => {
            if (peerConnection && !isVideoPlaying) {
                console.log('ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');
                
                // Ø¥Ø°Ø§ Ù…Ø±Øª 20 Ø«Ø§Ù†ÙŠØ© ÙˆÙ„Ù… ÙŠØ¸Ù‡Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                if (Date.now() - connectionStartTime > 20000) {
                    console.log('âš ï¸ Ù…Ø± ÙˆÙ‚Øª Ø·ÙˆÙŠÙ„ Ø¨Ø¯ÙˆÙ† ÙÙŠØ¯ÙŠÙˆØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„');
                    // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø§Ø¯Ø© Ø§ØªØµØ§Ù„ Ù‡Ù†Ø§
                }
            }
        }, 5000);
        
        let connectionStartTime = Date.now();
        
        setTimeout(() => {
            if (!video.srcObject || !isVideoPlaying) {
                console.log('â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ ÙÙŠØ¯ÙŠÙˆ');
                redirectToError('stream-ended');
            }
        }, 30000);
        
        window.onload = function() {
            connectionStartTime = Date.now();
            connectToStream();
        };
    </script>
</body>
</html>
