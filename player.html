<!DOCTYPE html>
<html>
<head>
    <title>المشاهد - مشاهدة البث</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; background: #222; color: white; text-align: center; padding: 20px; margin: 0; }
        video { background: black; border: 2px solid #555; width: 100%; max-width: 800px; }
        #message { font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>مشاهدة البث المباشر</h1>
    <p id="message">جارٍ البحث عن البث...</p>
    <video id="remoteVideo" autoplay playsinline></video>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <!-- الإصلاح: استخدام النسخة المخصصة للمتصفح من المكتبة -->
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>
    <script>
        const socket = io("https://new-antik-p2p-20.onrender.com");
        const mediasoupClient = window.mediasoupClient; // استخدام الكائن الصحيح
        const device = new mediasoupClient.Device();
        let consumerTransport;

        const remoteVideo = document.getElementById('remoteVideo');
        const messageEl = document.getElementById('message');

        const params = new URLSearchParams(window.location.search);
        const broadcastId = params.get('id');

        if (!broadcastId) {
            messageEl.innerText = 'خطأ: لم يتم تحديد معرف البث في الرابط.';
        } else {
            socket.on('connect', () => {
                socket.emit('checkBroadcast', broadcastId, ({ isBroadcasting }) => {
                    if (isBroadcasting) joinBroadcast();
                    else messageEl.innerText = 'البث غير متاح حاليًا. في انتظار بدء المعلم للبث...';
                });
            });

            socket.on('newBroadcast', (newBroadcastId) => {
                if (newBroadcastId === broadcastId && !consumerTransport) joinBroadcast();
            });
        }

        async function joinBroadcast() {
            try {
                messageEl.innerText = 'تم العثور على البث! جارٍ الاتصال...';
                const routerRtpCapabilities = await new Promise(r => socket.emit('getRouterRtpCapabilities', r));
                await device.load({ routerRtpCapabilities });

                const transportParams = await new Promise(r => socket.emit('createConsumerTransport', r));
                if (transportParams.error) throw new Error(transportParams.error);

                consumerTransport = device.createRecvTransport(transportParams);

                consumerTransport.on('connect', ({ dtlsParameters }, callback, errback) => {
                    socket.emit('connectConsumerTransport', { transportId: consumerTransport.id, dtlsParameters });
                    callback();
                });

                const stream = new MediaStream();
                remoteVideo.srcObject = stream;

                const { rtpCapabilities } = device;
                socket.emit('consume', { rtpCapabilities }, async (params) => {
                    if (params.error) throw new Error(params.error);
                    
                    const consumer = await consumerTransport.consume({
                        id: params.id,
                        producerId: params.producerId,
                        kind: params.kind,
                        rtpParameters: params.rtpParameters,
                    });
                    stream.addTrack(consumer.track);
                    socket.emit('resume', { consumerId: consumer.id });
                });
                
                messageEl.style.display = 'none';

            } catch (error) {
                console.error(error);
                messageEl.innerText = `فشل الاتصال بالبث: ${error.message}`;
            }
        }
    </script>
</body>
</html>
