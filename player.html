<!DOCTYPE html>
<html>
<head>
    <title>مشاهد البث</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h2>مشاهدة البث المباشر</h2>
    <video id="remoteVideo" autoplay playsinline style="width:100%; max-width:600px; border:1px solid #ccc;"></video>
    <p>الحالة: <span id="status">جارٍ البحث عن بث...</span></p>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>
    <script>
        const socket = io("https://new-antik-p2p-20.onrender.com");
        const mediasoupClient = window.mediasoupClient;
        const device = new mediasoupClient.Device();
        let consumerTransport, videoConsumer, broadcastId = "";
        const remoteVideo = document.getElementById('remoteVideo'), statusEl = document.getElementById('status');
        const urlParams = new URLSearchParams(window.location.search); broadcastId = urlParams.get('id');
        if (!broadcastId) { statusEl.innerText = '❌ لم يتم تحديد معرف البث في الرابط'; statusEl.style.color = 'red'; }
        else { joinBroadcast(); }

        async function joinBroadcast() {
            try {
                const checkResult = await new Promise(r => socket.emit('checkBroadcast', { roomId: broadcastId }, r));
                if (!checkResult.isBroadcasting) { statusEl.innerText = '❌ لا يوجد بث نشط'; statusEl.style.color = 'red'; return; }
                statusEl.innerText = 'جاري الاتصال بالبث...';
                const routerRtpCapabilities = await new Promise(r => socket.emit('getRouterRtpCapabilities', { roomId: broadcastId }, r));
                await device.load({ routerRtpCapabilities });
                const transportParams = await new Promise(r => socket.emit('createConsumerTransport', { roomId: broadcastId }, r));
                if (transportParams.error) throw new Error(transportParams.error);
                consumerTransport = device.createRecvTransport(transportParams);
                consumerTransport.on('connect', ({ dtlsParameters }, callback, errback) => {
                    socket.emit('connectConsumerTransport', { transportId: consumerTransport.id, dtlsParameters }, (res) => {
                        res.success ? callback() : errback(new Error(res.error));
                    });
                });
                const { rtpCapabilities } = device;
                const consumerParams = await new Promise(r => socket.emit('consume', { transportId: consumerTransport.id, rtpCapabilities }, r));
                if (consumerParams.error) throw new Error(consumerParams.error);
                const consumer = await consumerTransport.consume(consumerParams); videoConsumer = consumer;
                const stream = new MediaStream(); stream.addTrack(consumer.track); remoteVideo.srcObject = stream;
                statusEl.innerText = '✅ متصل بالبث!'; statusEl.style.color = 'green';
            } catch (err) {
                console.error(err); statusEl.innerText = `❌ فشل الاتصال: ${err.message}`; statusEl.style.color = 'red';
                setTimeout(() => { if (!videoConsumer) { statusEl.innerText = 'جاري إعادة المحاولة...'; joinBroadcast(); } }, 5000);
            }
        }
        socket.on('newBroadcast', (data) => { if (data.roomId === broadcastId && !videoConsumer) joinBroadcast(); });
    </script>
</body>
</html>
