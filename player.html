<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>مشاهدة البث</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #222; color: #fff; }
        video { width: 100%; max-width: 800px; background: #000; border: 1px solid #444; border-radius: 8px; }
        #status { margin-top: 10px; color: #aaa; }
        button { padding: 10px 20px; cursor: pointer; background: #28a745; color: white; border: none; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <h1>بث مباشر</h1>
    <video id="remoteVideo" autoplay playsinline controls></video>
    <p id="status">جاري البحث عن بث...</p>
    <button id="playBtn">اضغط للتشغيل</button>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>

    <script>
        const socket = io("https://new-antik-p2p-20.onrender.com");
        const mediasoupClient = window.mediasoupClient;
        const device = new mediasoupClient.Device();
        let consumerTransport;
        
        const remoteVideo = document.getElementById('remoteVideo');
        const statusEl = document.getElementById('status');
        const playBtn = document.getElementById('playBtn');

        // دالة للانضمام للبث
        const joinBroadcast = async () => {
            statusEl.innerText = 'تم العثور على بث، جاري الاتصال...';
            try {
                // 1. تحميل إعدادات الجهاز
                const routerRtpCapabilities = await new Promise(resolve => {
                    socket.emit('getRouterRtpCapabilities', resolve);
                });
                await device.load({ routerRtpCapabilities });

                // 2. إنشاء Transport للاستقبال
                const transportParams = await new Promise((resolve, reject) => {
                    socket.emit('createConsumerTransport', (data) => {
                        if (data.error) reject(data.error);
                        else resolve(data);
                    });
                });

                consumerTransport = device.createRecvTransport(transportParams);

                consumerTransport.on('connect', ({ dtlsParameters }, callback, errback) => {
                    socket.emit('connectConsumerTransport', { 
                        transportId: consumerTransport.id, 
                        dtlsParameters 
                    }, () => callback());
                });

                // 3. استهلاك البث (Consume)
                const { rtpCapabilities } = device;
                const consumerParams = await new Promise((resolve, reject) => {
                    socket.emit('consume', { 
                        transportId: consumerTransport.id, 
                        rtpCapabilities 
                    }, (data) => {
                        if (data.error) reject(data.error);
                        else resolve(data);
                    });
                });

                const consumer = await consumerTransport.consume(consumerParams);
                
                // 4. عرض الفيديو
                const stream = new MediaStream();
                stream.addTrack(consumer.track);
                remoteVideo.srcObject = stream;

                // 5. استئناف البث (Resume)
                await new Promise(resolve => {
                    socket.emit('resume', { consumerId: consumer.id }, resolve);
                });

                statusEl.innerText = 'تم الاتصال!';
                
                // تشغيل الفيديو في حال توقفه بسبب سياسات المتصفح
                try {
                    await remoteVideo.play();
                } catch (e) {
                    playBtn.style.display = 'inline-block';
                    playBtn.onclick = () => {
                        remoteVideo.play();
                        playBtn.style.display = 'none';
                    };
                }

            } catch (err) {
                console.error(err);
                statusEl.innerText = 'في انتظار بدء البث...';
            }
        };

        // الاستماع لحدث بدء بث جديد
        socket.on('new-producer', () => {
            console.log("New producer detected");
            joinBroadcast();
        });

        // المحاولة عند فتح الصفحة
        socket.on('connect', () => {
            // نحاول الانضمام مباشرة، إذا فشل (لعدم وجود بث) سيظهر الخطأ في الكونسول
            joinBroadcast();
        });
    </script>
</body>
</html>
