<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مشغل البث</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; overflow: hidden; background: #000; }
        #videoContainer { width: 100vw; height: 100vh; background: #000; position: relative; }
        #remoteVideo { width: 100%; height: 100%; object-fit: contain; background: #000; }
        /* إخفاء كل التحكمات */
        #remoteVideo::-webkit-media-controls { display: none !important; }
        #remoteVideo::-webkit-media-controls-panel { display: none !important; }
        #remoteVideo::-webkit-media-controls-play-button { display: none !important; }
        #remoteVideo::-webkit-media-controls-volume-slider { display: none !important; }
        #remoteVideo::-webkit-media-controls-mute-button { display: none !important; }
        #remoteVideo::-webkit-media-controls-timeline { display: none !important; }
        #remoteVideo::-webkit-media-controls-current-time-display { display: none !important; }
        #remoteVideo::-webkit-media-controls-time-remaining-display { display: none !important; }
        #remoteVideo::-webkit-media-controls-fullscreen-button { display: none !important; }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let peerConnection;
        
        const rtcConfig = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // 1. استخراج البيانات فقط
        function getParams() {
            const url = new URL(window.location.href);
            const roomParam = url.searchParams.get('room');
            if (!roomParam) return null;
            
            const parts = roomParam.split('/');
            if (parts.length < 2) return null;
            
            return {
                roomId: parts[0],
                userName: decodeURIComponent(parts[1])
            };
        }

        // 2. توجيه للخطأ فقط
        function goToError(errorType) {
            const url = new URL(window.location.href);
            const roomParam = url.searchParams.get('room') || '';
            window.location.href = `https://new-antik-p2p-20.onrender.com/error.html?room=${roomParam}&error=${errorType}`;
        }

        // 3. الاتصال
        function connect() {
            const params = getParams();
            if (!params) return goToError('no-room');
            
            socket.emit('viewer-join', {
                roomId: params.roomId,
                userName: params.userName
            });
        }

        // 4. معالجة الفيديو
        function handleStream(stream) {
            const video = document.getElementById('remoteVideo');
            video.srcObject = stream;
            video.play().catch(() => {
                // تجاهل خطأ التشغيل التلقائي
            });
        }

        // 5. WebRTC
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);
            
            peerConnection.ontrack = (event) => {
                handleStream(event.streams[0]);
            };
            
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    const params = getParams();
                    if (params) {
                        socket.emit('ice-candidate', {
                            roomId: params.roomId,
                            candidate: event.candidate
                        });
                    }
                }
            };
        }

        // 6. أحداث السيرفر
        socket.on('offer', async (data) => {
            if (!peerConnection) createPeerConnection();
            
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                const params = getParams();
                if (params) {
                    socket.emit('answer', {
                        to: data.from,
                        roomId: params.roomId,
                        sdp: answer
                    });
                }
            } catch (error) {
                goToError('connection-failed');
            }
        });

        socket.on('ice-candidate', async (data) => {
            if (peerConnection && data.candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (error) {
                    // تجاهل الخطأ
                }
            }
        });

        socket.on('broadcast-ended', () => {
            goToError('stream-ended');
        });

        socket.on('error', (data) => {
            goToError('server-error');
        });

        socket.on("connect_error", () => {
            goToError('server-unreachable');
        });

        // 7. بدء التشغيل
        window.onload = connect;
        
        // مهلة 30 ثانية
        setTimeout(() => {
            const video = document.getElementById('remoteVideo');
            if (!video.srcObject) {
                goToError('stream-ended');
            }
        }, 30000);
    </script>
</body>
</html>
