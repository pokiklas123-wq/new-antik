<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¬ Ù…Ø´ØºÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        
        #videoContainer {
            width: 100vw;
            height: 100vh;
            background: #000;
        }
        
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="remoteVideo" autoplay playsinline controls></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let peerConnection;
        let currentRoomId = null;
        let currentUserName = null;
        
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:global.stun.twilio.com:3478' }
            ]
        };

        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
        function getParamsFromURL() {
            try {
                const url = new URL(window.location.href);
                const roomParam = url.searchParams.get('room');
                
                if (!roomParam) throw new Error('no-room');
                
                const parts = roomParam.split('/');
                if (parts.length < 2 || !parts[0] || !parts[1]) {
                    throw new Error('invalid-format');
                }
                
                return {
                    roomId: parts[0],
                    userName: decodeURIComponent(parts[1])
                };
            } catch (error) {
                redirectToError(error.message);
                return null;
            }
        }

        // ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø®Ø·Ø£
        function redirectToError(errorType) {
            const url = new URL(window.location.href);
            const roomParam = url.searchParams.get('room') || '';
            
            window.location.href = `https://new-antik-p2p-20.onrender.com/error.html?room=${roomParam}&error=${errorType}`;
        }

        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function connectToStream() {
            const params = getParamsFromURL();
            if (!params) return;
            
            currentRoomId = params.roomId;
            currentUserName = params.userName;
            
            socket.emit('join-room', { 
                roomId: currentRoomId, 
                userName: currentUserName 
            });
        }

        // --- Ø§Ø³ØªÙ…Ø¹ Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³ÙŠØ±ÙØ± ---
        
        // Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ†Ø¶Ù… Ø¨Ù†Ø¬Ø§Ø­
        socket.on('joined-room', () => {
            console.log('âœ… ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„ØºØ±ÙØ©:', currentRoomId);
        });

        // Ø§Ù„Ø­Ø¯Ø« Ø§Ù„Ø£Ù‡Ù…: Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ø±Ø¶ WebRTC Ù…Ù† Ø§Ù„Ù…ÙØ¨Ø«
        socket.on('offer', async (data) => {
            console.log('ğŸ“© Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ø±Ø¶ WebRTC Ù…Ù† Ø§Ù„Ù…ÙØ¨Ø«:', data.from);
            
            if (!peerConnection) {
                createPeerConnection(data.from);
            }
            
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('answer', {
                    to: data.from,
                    roomId: currentRoomId,
                    sdp: answer
                });
                
                console.log('ğŸ“¤ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¨Ø«');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¹Ø±Ø¶:', error);
                redirectToError('connection-failed');
            }
        });

        // Ø§Ø³ØªÙ…Ø¹ Ø£ÙŠØ¶Ø§Ù‹ Ù„Ù€ 'webrtc-signal' (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…)
        socket.on('webrtc-signal', async (data) => {
            console.log('ğŸ“¡ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¥Ø´Ø§Ø±Ø© WebRTC:', data.type);
            
            if (!peerConnection && data.type === 'offer') {
                createPeerConnection(data.from);
            }
            
            try {
                if (data.type === 'offer') {
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.signal));
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    socket.emit('webrtc-signal', {
                        to: data.from,
                        type: 'answer',
                        signal: answer
                    });
                    
                } else if (data.type === 'candidate' && peerConnection) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.signal));
                }
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø´Ø§Ø±Ø©:', error);
                redirectToError('connection-failed');
            }
        });

        // Ø§Ø³ØªÙ…Ø¹ Ù„Ù€ 'stream-offer' (Ø§Ø³Ù… Ø«Ø§Ù„Ø« Ù…Ø­ØªÙ…Ù„)
        socket.on('stream-offer', async (data) => {
            console.log('ğŸ¥ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø«:', data);
            
            if (!peerConnection) {
                createPeerConnection(data.broadcasterId || 'broadcaster');
            }
            
            try {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                
                socket.emit('stream-answer', {
                    roomId: currentRoomId,
                    answer: answer
                });
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø«:', error);
                redirectToError('connection-failed');
            }
        });

        // Ø§Ø³ØªÙ…Ø¹ Ù„Ù…Ø±Ø´Ø­Ø§Øª ICE Ø¨Ø£Ø³Ù…Ø§Ø¡ Ù…Ø®ØªÙ„ÙØ©
        socket.on('ice-candidate', async (data) => {
            if (peerConnection && data.candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­ ICE:', error);
                }
            }
        });

        socket.on('candidate', async (data) => {
            if (peerConnection && data.candidate) {
                try {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­ ICE:', error);
                }
            }
        });

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC
        function createPeerConnection(broadcasterId) {
            console.log('ğŸ”§ Ø¥Ù†Ø´Ø§Ø¡ Ø§ØªØµØ§Ù„ WebRTC Ø¬Ø¯ÙŠØ¯');
            
            peerConnection = new RTCPeerConnection(rtcConfig);
            
            // Ø£Ù‡Ù… Ø¬Ø²Ø¡: Ø¹Ù†Ø¯Ù…Ø§ ÙŠØµÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
            peerConnection.ontrack = (event) => {
                console.log('ğŸ¬ ÙˆØµÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ!', event.streams[0]);
                
                const videoEl = document.getElementById('remoteVideo');
                videoEl.srcObject = event.streams[0];
                
                videoEl.play().catch(e => {
                    console.log('âš ï¸ Ø§Ù„Ù…ØªØµÙØ­ ÙŠØ·Ù„Ø¨ ØªÙØ§Ø¹Ù„Ø§Ù‹ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ');
                });
            };
            
            // Ø¥Ø±Ø³Ø§Ù„ Ù…Ø±Ø´Ø­Ø§Øª ICE
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice-candidate', {
                        roomId: currentRoomId,
                        candidate: event.candidate
                    });
                }
            };
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            peerConnection.onconnectionstatechange = () => {
                console.log('ğŸ”„ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„:', peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'disconnected' || 
                    peerConnection.connectionState === 'failed') {
                    setTimeout(() => {
                        redirectToError('stream-ended');
                    }, 2000);
                }
            };
        }

        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø®Ø·Ø£
        socket.on('broadcast-ended', () => {
            console.log('ğŸ›‘ Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø¨Ø« Ù…Ù† Ø§Ù„Ù…ÙØ¨Ø«');
            redirectToError('stream-ended');
        });
        
        socket.on('room-not-found', () => {
            console.log('ğŸ” Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
            redirectToError('room-not-found');
        });
        
        socket.on('error', (data) => {
            console.error('âŒ Ø®Ø·Ø£ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', data.message);
            redirectToError('server-error');
        });

        socket.on("connect_error", (error) => {
            console.error('âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±:', error.message);
            redirectToError('server-unreachable');
        });

        // Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = connectToStream;
        
        // Ø§Ù„Ù†Ù‚Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ¯ÙˆÙŠØ§Ù‹
        document.addEventListener('click', function() {
            const videoEl = document.getElementById('remoteVideo');
            if (videoEl.srcObject) {
                videoEl.play().catch(e => {
                    console.log('ğŸ‘† ØªÙ… Ø§Ù„Ù†Ù‚Ø±ØŒ Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...');
                });
            }
        });

        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠØµÙ„ Ø´ÙŠØ¡
        setTimeout(() => {
            const videoEl = document.getElementById('remoteVideo');
            if (!videoEl.srcObject) {
                console.log('â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚ØªØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø«');
                redirectToError('stream-ended');
            }
        }, 30000);
    </script>
</body>
</html>
